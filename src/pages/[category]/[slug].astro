---
// src/pages/[category]/[slug].astro
// Dynamic blog post page matching existing URL structure: /category/slug/

// 1. Get all paths (category/slug combinations) from WordPress to generate pages
export async function getStaticPaths() {
  // Helper function to fetch with retry (defined inside to have proper scope)
  async function fetchWithRetry(url, options = {}, retries = 3) {
    for (let i = 0; i < retries; i++) {
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        const response = await fetch(url, {
          ...options,
          signal: controller.signal
        });

        clearTimeout(timeout);

        if (response.ok) {
          return response;
        }

        if (i < retries - 1) {
          console.log(`Attempt ${i + 1} failed, retrying...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // Exponential backoff
        }
      } catch (error) {
        if (i < retries - 1) {
          console.log(`Attempt ${i + 1} failed with error: ${error.message}, retrying...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        } else {
          throw error;
        }
      }
    }
    throw new Error(`Failed after ${retries} attempts`);
  }

  // Use admin subdomain for WordPress REST API
  const WORDPRESS_BASE = "https://admin.startupyeti.com";

  try {
    // Fetch all published posts using REST API with pagination
    let allPosts = [];
    let page = 1;
    let hasMore = true;

    console.log(`Fetching posts from: ${WORDPRESS_BASE}/wp-json/wp/v2/posts`);

    while (hasMore) {
      const url = `${WORDPRESS_BASE}/wp-json/wp/v2/posts?per_page=100&page=${page}&status=publish&_fields=slug,categories`;

      try {
        const response = await fetchWithRetry(url, {
          headers: { "User-Agent": "StartupYeti/1.0 (Astro Static Site Generator)" }
        });

        const posts = await response.json();
        allPosts.push(...posts);
        console.log(`Fetched page ${page}: ${posts.length} posts`);

        // Check if there are more pages
        const totalPages = parseInt(response.headers.get('X-WP-TotalPages') || '1');
        hasMore = page < totalPages;
        page++;
      } catch (error) {
        console.error(`Failed to fetch posts page ${page} after retries:`, error.message);
        break;
      }
    }

    console.log(`✅ Fetched ${allPosts.length} posts from WordPress REST API`);

    if (allPosts.length === 0) {
      console.warn('No posts found in WordPress.');
      return [];
    }

    // Fetch category data to map IDs to slugs
    const categoriesResponse = await fetchWithRetry(
      `${WORDPRESS_BASE}/wp-json/wp/v2/categories?per_page=100&_fields=id,slug`,
      {
        headers: { "User-Agent": "StartupYeti/1.0 (Astro Static Site Generator)" }
      }
    );
    const categories = await categoriesResponse.json();
    const categoryMap = Object.fromEntries(categories.map(c => [c.id, c.slug]));

    // Create paths using category slug + post slug to match existing URLs
    return allPosts.map((post) => {
      const categoryId = post.categories[0];
      const categorySlug = categoryMap[categoryId] || 'uncategorized';
      return {
        params: {
          category: categorySlug.toLowerCase(),
          slug: post.slug
        },
      };
    });
  } catch (error) {
    console.error('Error fetching WordPress posts:', error);
    return [];
  }
}

// 2. Get the specific data for the current page
const { category, slug } = Astro.params;
const WORDPRESS_BASE = "https://admin.startupyeti.com";

// Retry helper for individual post fetching
async function fetchWithRetry(url, options = {}, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000);
      const response = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timeout);
      if (response.ok) return response;
      if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    } catch (error) {
      if (i < retries - 1) await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
      else throw error;
    }
  }
  throw new Error(`Failed after ${retries} attempts`);
}

const response = await fetchWithRetry(
  `${WORDPRESS_BASE}/wp-json/wp/v2/posts?slug=${slug}&_embed`,
  {
    headers: { "User-Agent": "StartupYeti/1.0 (Astro Static Site Generator)" }
  }
);

const posts = await response.json();
const restPost = posts[0];

if (!restPost) {
  throw new Error(`Post not found: ${slug}`);
}

// Transform REST API response to match the GraphQL structure
const post = {
  title: restPost.title.rendered,
  content: restPost.content.rendered,
  date: restPost.date,
  excerpt: restPost.excerpt.rendered,
  featuredImage: restPost._embedded?.['wp:featuredmedia']?.[0] ? {
    node: {
      sourceUrl: restPost._embedded['wp:featuredmedia'][0].source_url,
      altText: restPost._embedded['wp:featuredmedia'][0].alt_text || restPost.title.rendered
    }
  } : null,
  author: {
    node: {
      name: restPost._embedded?.author?.[0]?.name || 'Startup Yeti',
      avatar: {
        url: restPost._embedded?.author?.[0]?.avatar_urls?.['96'] || ''
      }
    }
  },
  categories: {
    nodes: (restPost._embedded?.['wp:term']?.[0] || []).map(cat => ({
      name: cat.name,
      slug: cat.slug
    }))
  },
  tags: {
    nodes: (restPost._embedded?.['wp:term']?.[1] || []).map(tag => ({
      name: tag.name
    }))
  }
};

// Calculate reading time
const wordCount = post.content.replace(/<[^>]*>/g, '').split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// SEO data
const siteUrl = "https://www.startupyeti.com";
const pageUrl = `${siteUrl}/${category}/${slug}`;
const metaDescription = post.excerpt.replace(/<[^>]*>/g, '').substring(0, 160);
const metaTitle = `${post.title} | Startup Yeti`;
const ogImage = post.featuredImage?.node?.sourceUrl || `${siteUrl}/logo.png`;
const publishedDate = new Date(post.date).toISOString();
const categoryName = post.categories.nodes[0]?.name || 'Article';
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png" />
    <link rel="apple-touch-icon" href="/favicon-192x192.png" />

    <!-- Primary Meta Tags -->
    <title>{metaTitle}</title>
    <meta name="title" content={metaTitle} />
    <meta name="description" content={metaDescription} />
    <meta name="author" content={post.author.node.name} />
    <link rel="canonical" href={pageUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="Startup Yeti" />
    <meta property="article:published_time" content={publishedDate} />
    <meta property="article:author" content={post.author.node.name} />
    <meta property="article:section" content={categoryName} />
    {post.tags.nodes.map((tag) => (
      <meta property="article:tag" content={tag.name} />
    ))}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={pageUrl} />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- JSON-LD Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": post.title,
      "description": metaDescription,
      "image": ogImage,
      "datePublished": publishedDate,
      "dateModified": publishedDate,
      "author": {
        "@type": "Person",
        "name": post.author.node.name
      },
      "publisher": {
        "@type": "Organization",
        "name": "Startup Yeti",
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/logo.png`
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": pageUrl
      },
      "articleSection": categoryName,
      "keywords": post.tags.nodes.map(tag => tag.name).join(', '),
      "wordCount": wordCount,
      "timeRequired": `PT${readingTime}M`
    })} />

    <!-- Breadcrumb Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": categoryName,
          "item": `${siteUrl}/${category}`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": post.title,
          "item": pageUrl
        }
      ]
    })} />

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5Y6SRMMDYG"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5Y6SRMMDYG');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">


    <style>
      img[src="/logo.png"] {
        background: transparent !important;
        mix-blend-mode: normal;
      }
    </style>
  </head>

  <body class="bg-slate-50 text-slate-700 font-sans antialiased selection:bg-yeti-100 selection:text-yeti-900">

    <!-- Simple Navigation for Blog Posts -->
    <nav class="fixed w-full top-0 z-50 bg-white/95 backdrop-blur-xl border-b border-slate-200/60 shadow-sm transition-all duration-500">
      <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
        <a href="/" class="flex items-center hover:opacity-80 transition-all duration-300 hover:scale-105">
          <img src="/logo.png" alt="Startup Yeti" class="h-12 w-auto object-contain" />
        </a>

        <div class="flex items-center gap-4">
          <a href="/blog" class="text-sm font-semibold text-slate-600 hover:text-yeti-600 transition-colors">
            ← All Articles
          </a>
          <a href="/" class="px-6 py-2.5 rounded-full bg-gradient-to-r from-yeti-600 to-yeti-700 text-white font-bold text-sm hover:from-yeti-700 hover:to-yeti-800 shadow-lg transition-all">
            Home
          </a>
        </div>
      </div>
    </nav>

    <!-- Reading Progress Bar -->
    <div id="reading-progress" class="fixed top-20 left-0 h-1 bg-gradient-to-r from-yeti-600 to-cyan-500 transition-all duration-150 z-50" style="width: 0%"></div>

    <main class="pt-20">

      <!-- Hero Section -->
      <section class="relative py-20 px-6 bg-gradient-to-b from-white to-slate-50">
        <div class="max-w-4xl mx-auto">

          <!-- Category Badge -->
          {post.categories.nodes.length > 0 && (
            <div class="mb-8">
              <span class="inline-flex items-center px-4 py-2 rounded-full glass border-yeti-300 text-yeti-700 text-xs font-bold uppercase tracking-widest">
                {post.categories.nodes[0].name}
              </span>
            </div>
          )}

          <!-- Title -->
          <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-extrabold text-slate-900 mb-8 leading-[1.1] tracking-tight font-serif">
            {post.title}
          </h1>

          <!-- Meta Info -->
          <div class="flex flex-wrap items-center gap-6 text-slate-600 mb-12 pb-8 border-b border-slate-200">
            <div class="flex items-center gap-3">
              {post.author.node.avatar && (
                <img src={post.author.node.avatar.url} alt={post.author.node.name} class="w-12 h-12 rounded-full" />
              )}
              <div>
                <p class="font-bold text-slate-900">{post.author.node.name}</p>
                <p class="text-sm text-slate-500">{new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
              </div>
            </div>
            <div class="flex items-center gap-2 text-sm font-semibold">
              <svg class="w-5 h-5 text-yeti-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <span>{readingTime} min read</span>
            </div>
          </div>

          <!-- Featured Image -->
          {post.featuredImage && (
            <img
              src={post.featuredImage.node.sourceUrl}
              alt={post.featuredImage.node.altText || post.title}
              class="w-full h-auto max-h-[500px] object-cover rounded-3xl shadow-2xl mb-12"
            />
          )}
        </div>
      </section>

      <!-- Article Content -->
      <section class="py-12 px-6">
        <article
          class="prose prose-lg prose-slate max-w-4xl mx-auto
                 prose-headings:font-serif prose-headings:font-bold prose-headings:text-slate-900
                 prose-h2:text-4xl prose-h2:mt-12 prose-h2:mb-6
                 prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
                 prose-p:text-slate-600 prose-p:leading-relaxed prose-p:mb-6
                 prose-a:text-yeti-600 prose-a:font-semibold prose-a:no-underline hover:prose-a:text-yeti-700 hover:prose-a:underline
                 prose-strong:text-slate-900 prose-strong:font-bold
                 prose-ul:my-6 prose-li:text-slate-600
                 prose-blockquote:border-l-4 prose-blockquote:border-yeti-500 prose-blockquote:bg-yeti-50/50 prose-blockquote:py-4 prose-blockquote:px-6 prose-blockquote:rounded-r-xl prose-blockquote:not-italic
                 prose-code:text-yeti-700 prose-code:bg-yeti-50 prose-code:px-2 prose-code:py-1 prose-code:rounded prose-code:font-mono prose-code:text-sm
                 prose-img:rounded-2xl prose-img:shadow-xl"
          set:html={post.content}
        />
      </section>

      <!-- Tags Section -->
      {post.tags.nodes.length > 0 && (
        <section class="py-12 px-6 bg-slate-50 border-t border-slate-200">
          <div class="max-w-4xl mx-auto">
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest mb-4">Tags</h3>
            <div class="flex flex-wrap gap-3">
              {post.tags.nodes.map((tag) => (
                <span class="px-4 py-2 bg-white rounded-xl border border-slate-200 text-slate-700 text-sm font-semibold hover:border-yeti-400 hover:text-yeti-700 transition-all cursor-pointer">
                  {tag.name}
                </span>
              ))}
            </div>
          </div>
        </section>
      )}

      <!-- CTA Section -->
      <section class="py-20 px-6 bg-gradient-to-b from-slate-50 to-white">
        <div class="max-w-4xl mx-auto text-center">
          <div class="glass border-slate-300 rounded-3xl p-12 shadow-2xl">
            <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 font-serif">
              Get More Tactical Advice
            </h2>
            <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto">
              Join 50k+ founders getting weekly insights on building and scaling remote teams.
            </p>
            <form class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto" data-newsletter-form>
              <input
                type="email"
                placeholder="Enter your email"
                class="flex-1 px-6 py-4 rounded-xl border-2 border-slate-200 focus:border-yeti-500 focus:ring-2 focus:ring-yeti-500 transition-all"
                required
              />
              <button
                type="submit"
                class="px-8 py-4 rounded-xl bg-gradient-to-r from-yeti-600 to-yeti-700 text-white font-bold hover:from-yeti-700 hover:to-yeti-800 shadow-lg hover:shadow-glow transition-all whitespace-nowrap"
              >
                Subscribe
              </button>
            </form>
          </div>
        </div>
      </section>

    </main>

    <!-- Simple Footer -->
    <footer class="bg-slate-900 text-white py-12">
      <div class="max-w-7xl mx-auto px-6">
        <div class="h-20 md:h-24 mb-2">
          <img src="/footer logo.png" class="h-full w-auto" alt="Startup Yeti" />
        </div>
        <p class="text-slate-300 mb-4 text-base text-left">&copy; {new Date().getFullYear()} Startup Yeti. All rights reserved.</p>
        <div class="flex gap-6">
          <a href="/" class="hover:text-yeti-400 transition-colors">Home</a>
          <a href="/blog" class="hover:text-yeti-400 transition-colors">Blog</a>
          <a href="/privacy-policy" class="hover:text-yeti-400 transition-colors">Privacy Policy</a>
          <a href="https://www.linkedin.com/company/startup-yeti/" target="_blank" rel="noopener noreferrer" class="hover:text-yeti-400 transition-colors">LinkedIn</a>
        </div>
      </div>
    </footer>

    <!-- Newsletter Form Handler -->
    <script is:inline src="/js/newsletter.js"></script>

    <script>
      // Reading progress bar
      (function() {
        const progressBar = document.getElementById('reading-progress');

        window.addEventListener('scroll', () => {
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.scrollHeight;
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const scrollPercent = (scrollTop / (documentHeight - windowHeight)) * 100;
          progressBar.style.width = scrollPercent + '%';
        });
      })();
    </script>
  </body>
</html>
